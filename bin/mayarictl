#!/usr/bin/env bash
set -euo pipefail

# Mayari Control Script
# PDF quote extraction tool with native Kokoro TTS

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
PID_DIR="$ROOT_DIR/.pids"
LOG_DIR="$ROOT_DIR/.logs"
APP_FILENAME_FILE="$ROOT_DIR/macos/Flutter/ephemeral/.app_filename"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

mkdir -p "$PID_DIR" "$LOG_DIR"

# ============== Flutter Functions ==============

resolve_release_app_path() {
    local release_dir="$ROOT_DIR/build/macos/Build/Products/Release"
    local built_app_file=""

    if [ -f "$APP_FILENAME_FILE" ]; then
        built_app_file="$(tr -d '[:space:]' < "$APP_FILENAME_FILE")"
    fi

    if [ -n "$built_app_file" ] && [ -d "$release_dir/$built_app_file" ]; then
        echo "$release_dir/$built_app_file"
        return 0
    fi

    if [ -d "$release_dir/mayari_temp.app" ]; then
        echo "$release_dir/mayari_temp.app"
        return 0
    fi

    if [ -d "$release_dir/Mayari.app" ]; then
        echo "$release_dir/Mayari.app"
        return 0
    fi

    return 1
}

embed_swift_package_frameworks() {
    local app_path="$1"
    local package_frameworks_dir="$ROOT_DIR/build/macos/Build/Products/Release/PackageFrameworks"
    local app_frameworks_dir="$app_path/Contents/Frameworks"

    if [ ! -d "$package_frameworks_dir" ]; then
        echo -e "${YELLOW}PackageFrameworks not found, skipping embed step${NC}"
        return 0
    fi

    mkdir -p "$app_frameworks_dir"

    local copied_count=0
    for framework in "$package_frameworks_dir"/*.framework; do
        [ -d "$framework" ] || continue
        local framework_name
        framework_name="$(basename "$framework")"
        if [ ! -d "$app_frameworks_dir/$framework_name" ]; then
            cp -R "$framework" "$app_frameworks_dir/"
            copied_count=$((copied_count + 1))
        fi
    done

    if [ "$copied_count" -gt 0 ]; then
        echo "Embedded $copied_count Swift framework(s)"
    fi

    if [ ! -d "$app_frameworks_dir/KokoroSwift.framework" ]; then
        echo -e "${RED}Missing KokoroSwift.framework after embed step${NC}"
        return 1
    fi
}

is_running() {
    pgrep -f "mayari_temp.app/Contents/MacOS" >/dev/null 2>&1
}

start_flutter() {
    local mode="${1:-release}"
    echo -e "${BLUE}Starting Mayari ($mode mode)...${NC}"

    cd "$ROOT_DIR"

    if [ "$mode" = "dev" ]; then
        flutter run -d macos > "$LOG_DIR/flutter.log" 2>&1 &
        echo $! > "$PID_DIR/flutter.pid"
        echo -e "${GREEN}Mayari started in dev mode${NC}"
    else
        # Build release
        echo "Building Mayari..."
        flutter build macos --release

        # Launch app
        local app_path
        if app_path="$(resolve_release_app_path)"; then
            embed_swift_package_frameworks "$app_path"
            open "$app_path"
            echo -e "${GREEN}Mayari launched${NC}"
        else
            echo -e "${YELLOW}Release app not found, trying dev mode${NC}"
            flutter run -d macos &
            echo $! > "$PID_DIR/flutter.pid"
        fi
    fi
}

stop_flutter() {
    echo -e "${BLUE}Stopping Mayari...${NC}"

    # Kill by PID file
    if [ -f "$PID_DIR/flutter.pid" ]; then
        kill $(cat "$PID_DIR/flutter.pid") 2>/dev/null || true
        rm -f "$PID_DIR/flutter.pid"
    fi

    # Kill app by name
    pkill -f "mayari_temp.app/Contents/MacOS" 2>/dev/null || true
    pkill -f "flutter run" 2>/dev/null || true

    echo -e "${GREEN}Mayari stopped${NC}"
}

build_flutter() {
    echo -e "${BLUE}Building Mayari...${NC}"
    cd "$ROOT_DIR"
    flutter pub get
    flutter build macos --release
    echo -e "${GREEN}Build complete${NC}"
    echo "App at: $ROOT_DIR/build/macos/Build/Products/Release/mayari_temp.app"
}

# ============== Main Commands ==============

cmd_up() {
    local flutter_mode="release"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --dev) flutter_mode="dev" ;;
            *) echo "Unknown option: $1" ;;
        esac
        shift
    done

    echo -e "${BLUE}=== Starting Mayari ===${NC}"
    if is_running; then
        echo "Mayari already running, restarting..."
        stop_flutter
    fi
    start_flutter "$flutter_mode"
    echo ""
    echo -e "${GREEN}=== Mayari Ready ===${NC}"
    echo "TTS uses native KokoroSwift (no server required)"
    echo "Model downloads automatically on first use (~340MB)"
}

cmd_down() {
    echo -e "${BLUE}=== Stopping Mayari ===${NC}"
    stop_flutter
    echo -e "${GREEN}=== Mayari Stopped ===${NC}"
}

cmd_status() {
    echo -e "${BLUE}=== Mayari Status ===${NC}"
    echo ""

    # Flutter status
    local flutter_running=false
    if [ -f "$PID_DIR/flutter.pid" ]; then
        local pid=$(cat "$PID_DIR/flutter.pid")
        if kill -0 "$pid" 2>/dev/null; then
            flutter_running=true
            echo -e "${GREEN}●${NC} Mayari App: ${GREEN}RUNNING${NC} [PID: $pid]"
        fi
    fi
    if [ "$flutter_running" = false ]; then
        local app_pid=$(pgrep -f "mayari_temp.app/Contents/MacOS" 2>/dev/null | head -1 || true)
        if [ -n "$app_pid" ]; then
            echo -e "${GREEN}●${NC} Mayari App: ${GREEN}RUNNING${NC} [PID: $app_pid]"
        else
            echo -e "${RED}○${NC} Mayari App: ${RED}STOPPED${NC}"
        fi
    fi

    echo ""
    echo -e "${GREEN}TTS Engine:${NC} Native KokoroSwift (no server)"
    echo -e "${GREEN}Requirements:${NC} macOS 15.0+, Apple Silicon"
}

cmd_logs() {
    local log_file="$LOG_DIR/flutter.log"

    if [ -f "$log_file" ]; then
        echo "Tailing $log_file (Ctrl+C to exit)..."
        tail -f "$log_file"
    else
        echo "Log file not found: $log_file"
        echo "Run 'mayarictl up --dev' to generate logs"
    fi
}

# ============== Usage ==============

usage() {
    cat << EOF
${BLUE}Mayari Control Script${NC}
PDF quote extraction tool with native Kokoro TTS

Usage: mayarictl <command> [options]

${GREEN}Commands:${NC}
    up [options]     Start Mayari
        --dev        Run in dev mode (default: release)
    down             Stop Mayari
    restart          Restart Mayari
    status           Show status
    build            Build macOS release app
    logs             Tail logs
    clean            Clean logs and PID files
    version          Show version info

${GREEN}Examples:${NC}
    mayarictl up        # Start (builds and runs release)
    mayarictl up --dev  # Start in dev mode
    mayarictl status    # Check if running
    mayarictl logs      # Tail Flutter logs

${GREEN}Notes:${NC}
    TTS runs natively via KokoroSwift (no Python/server required)
    Model (~340MB) downloads automatically on first TTS use
    Requires macOS 15.0+ and Apple Silicon

EOF
}

# ============== Main ==============

case "${1:-}" in
    up) shift; cmd_up "$@" ;;
    down) cmd_down ;;
    restart) shift; cmd_down; sleep 1; cmd_up "$@" ;;
    status) cmd_status ;;
    build) build_flutter ;;
    logs) cmd_logs ;;
    clean)
        echo -e "${BLUE}Cleaning temporary files...${NC}"
        rm -f "$LOG_DIR"/*.log 2>/dev/null || true
        rm -f "$PID_DIR"/*.pid 2>/dev/null || true
        echo -e "${GREEN}Cleaned.${NC}"
        ;;
    version)
        echo -e "${BLUE}Mayari - PDF Quote Extraction with Native TTS${NC}"
        echo "Version: 1.0.2"
        echo "Root: $ROOT_DIR"
        echo ""
        echo "Components:"
        command -v flutter >/dev/null && echo "  Flutter: $(flutter --version 2>&1 | head -1 | cut -d' ' -f2)"
        echo "  TTS: KokoroSwift (native)"
        echo "  ML Framework: Apple MLX"
        ;;
    help|-h|--help) usage ;;
    *) usage ;;
esac
