#!/usr/bin/env bash
set -euo pipefail

# Mayari Control Script
# PDF quote extraction tool with Kokoro TTS

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$ROOT_DIR/backend"
VENV_DIR="$BACKEND_DIR/.venv"
PID_DIR="$ROOT_DIR/.pids"
LOG_DIR="$ROOT_DIR/.logs"

# Ports
TTS_PORT=8787

# Flutter app name
FLUTTER_APP_NAME="mayari"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

mkdir -p "$PID_DIR" "$LOG_DIR"

# ============== Helper Functions ==============

print_status() {
    local name="$1"
    local port="$2"

    if lsof -ti:"$port" &>/dev/null; then
        local pid=$(lsof -ti:"$port" | head -1)
        echo -e "${GREEN}●${NC} $name: ${GREEN}RUNNING${NC} [PID: $pid, Port: $port]"
    else
        echo -e "${RED}○${NC} $name: ${RED}STOPPED${NC}"
    fi
    return 0
}

print_status_pid() {
    local name="$1"
    local pid_file="$2"

    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}●${NC} $name: ${GREEN}RUNNING${NC} [PID: $pid]"
            return 0
        fi
    fi
    echo -e "${RED}○${NC} $name: ${RED}STOPPED${NC}"
    return 1
}

kill_port() {
    local port="$1"
    local pids=$(lsof -ti:"$port" 2>/dev/null || true)
    if [ -n "$pids" ]; then
        echo "$pids" | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

wait_for_health() {
    local url="$1"
    local max_retries="${2:-30}"
    local retry=0

    echo -n "Waiting for $url "
    while [ $retry -lt $max_retries ]; do
        if curl -s "$url" &>/dev/null; then
            echo -e " ${GREEN}OK${NC}"
            return 0
        fi
        echo -n "."
        sleep 1
        ((retry++))
    done
    echo -e " ${RED}FAILED${NC}"
    return 1
}

# ============== TTS Server Functions ==============

setup_venv() {
    if [ ! -d "$VENV_DIR" ]; then
        echo -e "${BLUE}Creating Python venv...${NC}"
        python3 -m venv "$VENV_DIR"
    fi

    source "$VENV_DIR/bin/activate"

    # Install requirements if needed
    if [ -f "$BACKEND_DIR/requirements.txt" ]; then
        echo -e "${BLUE}Installing Python dependencies...${NC}"
        pip install -q -r "$BACKEND_DIR/requirements.txt"
    fi
}

start_tts() {
    echo -e "${BLUE}Starting TTS server...${NC}"

    # Kill existing
    kill_port $TTS_PORT

    # Setup venv
    setup_venv

    # Start the FastAPI server
    cd "$BACKEND_DIR"
    source "$VENV_DIR/bin/activate"
    nohup python main.py > "$LOG_DIR/tts.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_DIR/tts.pid"
    deactivate 2>/dev/null || true

    wait_for_health "http://localhost:$TTS_PORT/health" 60

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}TTS server started${NC} on port $TTS_PORT"
    else
        echo -e "${RED}TTS server failed to start${NC}"
        echo -e "${YELLOW}Check logs: $LOG_DIR/tts.log${NC}"
        tail -20 "$LOG_DIR/tts.log" 2>/dev/null || true
        return 1
    fi
}

stop_tts() {
    echo -e "${BLUE}Stopping TTS server...${NC}"

    # Kill by PID file
    if [ -f "$PID_DIR/tts.pid" ]; then
        local pid=$(cat "$PID_DIR/tts.pid")
        kill "$pid" 2>/dev/null || true
        rm -f "$PID_DIR/tts.pid"
    fi

    # Also kill by port
    kill_port $TTS_PORT

    echo -e "${GREEN}TTS server stopped${NC}"
}

test_tts() {
    echo -e "${BLUE}Testing TTS synthesis...${NC}"

    # Check if server is running
    if ! curl -s "http://localhost:$TTS_PORT/health" &>/dev/null; then
        echo -e "${YELLOW}TTS server not running. Starting...${NC}"
        start_tts
    fi

    # Test synthesis
    echo "Synthesizing test audio..."
    local output_file="$LOG_DIR/test_output.wav"

    local response=$(curl -s -w "\n%{http_code}" -X POST "http://localhost:$TTS_PORT/api/kokoro/generate" \
        -H "Content-Type: application/json" \
        -d '{"text": "Hello, this is a test of the Kokoro text to speech system.", "voice": "bf_emma", "speed": 1.0}')

    local http_code=$(echo "$response" | tail -1)
    local body=$(echo "$response" | head -n -1)

    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}Success!${NC}"
        echo "Response: $body"

        # Get the audio URL and download it
        local audio_url=$(echo "$body" | python3 -c "import sys,json; print(json.load(sys.stdin).get('audio_url',''))" 2>/dev/null || true)
        if [ -n "$audio_url" ]; then
            curl -s "http://localhost:$TTS_PORT$audio_url" -o "$output_file"
            local file_size=$(stat -f%z "$output_file" 2>/dev/null || stat -c%s "$output_file" 2>/dev/null)
            echo -e "Audio file: $output_file (${file_size} bytes)"

            # Try to play the audio
            if command -v afplay &>/dev/null; then
                echo "Playing audio..."
                afplay "$output_file"
            fi
        fi
    else
        echo -e "${RED}Failed with HTTP $http_code${NC}"
        echo "$body"
        return 1
    fi
}

# ============== Flutter Functions ==============

start_flutter() {
    local mode="${1:-release}"
    echo -e "${BLUE}Starting Flutter app ($mode mode)...${NC}"

    cd "$ROOT_DIR"

    if [ "$mode" = "dev" ]; then
        flutter run -d macos > "$LOG_DIR/flutter.log" 2>&1 &
        echo $! > "$PID_DIR/flutter.pid"
        echo -e "${GREEN}Flutter started in dev mode${NC}"
    else
        # Build release
        echo "Building Flutter app..."
        flutter build macos --release

        # Launch app
        local app_path="$ROOT_DIR/build/macos/Build/Products/Release/mayari_temp.app"
        if [ -d "$app_path" ]; then
            open "$app_path"
            echo -e "${GREEN}Flutter app launched${NC}"
        else
            echo -e "${YELLOW}App not found at $app_path, trying dev mode${NC}"
            flutter run -d macos &
            echo $! > "$PID_DIR/flutter.pid"
        fi
    fi
}

stop_flutter() {
    echo -e "${BLUE}Stopping Flutter app...${NC}"

    # Kill by PID file
    if [ -f "$PID_DIR/flutter.pid" ]; then
        kill $(cat "$PID_DIR/flutter.pid") 2>/dev/null || true
        rm -f "$PID_DIR/flutter.pid"
    fi

    # Kill app by name
    pkill -f "mayari_temp.app/Contents/MacOS" 2>/dev/null || true
    pkill -f "flutter run" 2>/dev/null || true

    echo -e "${GREEN}Flutter stopped${NC}"
}

build_flutter() {
    echo -e "${BLUE}Building Flutter app...${NC}"
    cd "$ROOT_DIR"
    flutter pub get
    flutter build macos --release
    echo -e "${GREEN}Build complete${NC}"
    echo "App at: $ROOT_DIR/build/macos/Build/Products/Release/mayari_temp.app"
}

# ============== Main Commands ==============

cmd_up() {
    local skip_flutter=false
    local flutter_mode="release"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --no-flutter) skip_flutter=true ;;
            --dev) flutter_mode="dev" ;;
            *) echo "Unknown option: $1" ;;
        esac
        shift
    done

    echo -e "${BLUE}=== Starting Mayari ===${NC}"

    # Start TTS server
    start_tts || echo -e "${YELLOW}TTS server failed, continuing...${NC}"

    # Start Flutter
    if [ "$skip_flutter" = false ]; then
        start_flutter "$flutter_mode"
    fi

    echo ""
    echo -e "${GREEN}=== Mayari Ready ===${NC}"
    echo -e "TTS Server: http://localhost:$TTS_PORT"
    echo -e "TTS Health: http://localhost:$TTS_PORT/health"
    echo -e "TTS Voices: http://localhost:$TTS_PORT/api/kokoro/voices"
}

cmd_down() {
    echo -e "${BLUE}=== Stopping Mayari ===${NC}"
    stop_flutter
    stop_tts
    echo -e "${GREEN}=== Mayari Stopped ===${NC}"
}

cmd_status() {
    echo -e "${BLUE}=== Mayari Status ===${NC}"
    echo ""
    echo -e "${GREEN}Services:${NC}"
    print_status "TTS Server" $TTS_PORT

    # Flutter status
    local flutter_running=false
    if [ -f "$PID_DIR/flutter.pid" ]; then
        local pid=$(cat "$PID_DIR/flutter.pid")
        if kill -0 "$pid" 2>/dev/null; then
            flutter_running=true
            echo -e "${GREEN}●${NC} Flutter App: ${GREEN}RUNNING${NC} [PID: $pid]"
        fi
    fi
    if [ "$flutter_running" = false ]; then
        local app_pid=$(pgrep -f "mayari_temp.app/Contents/MacOS" 2>/dev/null | head -1 || true)
        if [ -n "$app_pid" ]; then
            echo -e "${GREEN}●${NC} Flutter App: ${GREEN}RUNNING${NC} [PID: $app_pid]"
        else
            echo -e "${RED}○${NC} Flutter App: ${RED}STOPPED${NC}"
        fi
    fi

    echo ""
    echo -e "${GREEN}Logs:${NC}"
    echo "  mayarictl logs tts      - TTS server logs"
    echo "  mayarictl logs flutter  - Flutter logs"
    echo "  mayarictl logs all      - Tail all logs"
}

cmd_restart() {
    cmd_down
    sleep 2
    cmd_up "$@"
}

cmd_logs() {
    local target="${1:-tts}"

    case "$target" in
        tts)
            log_file="$LOG_DIR/tts.log"
            ;;
        flutter)
            log_file="$LOG_DIR/flutter.log"
            ;;
        all)
            echo "Tailing all logs (Ctrl+C to exit)..."
            tail -f "$LOG_DIR"/*.log 2>/dev/null
            return
            ;;
        *)
            log_file="$LOG_DIR/$target.log"
            ;;
    esac

    if [ -f "$log_file" ]; then
        echo "Tailing $log_file (Ctrl+C to exit)..."
        tail -f "$log_file"
    else
        echo "Log file not found: $log_file"
        echo "Available logs:"
        ls -1 "$LOG_DIR"/*.log 2>/dev/null || echo "  (none)"
    fi
}

# ============== Usage ==============

usage() {
    cat << EOF
${BLUE}Mayari Control Script${NC}
PDF quote extraction tool with Kokoro TTS

Usage: mayarictl <command> [options]

${GREEN}Service Commands:${NC}
    up [options]            Start all services (TTS + Flutter)
        --no-flutter        Skip Flutter app
        --dev               Run Flutter in dev mode (default: release)
    down                    Stop all services
    restart                 Restart all services
    status                  Show service status

${GREEN}TTS Commands:${NC}
    tts start               Start TTS server only
    tts stop                Stop TTS server
    tts test                Test TTS synthesis (generates and plays audio)
    tts status              Check TTS server status

${GREEN}Flutter Commands:${NC}
    flutter start [--dev]   Start Flutter app
    flutter stop            Stop Flutter app
    flutter build           Build Flutter macOS app

${GREEN}Utility Commands:${NC}
    logs [service]          Tail logs (tts|flutter|all)
    clean                   Clean logs and PID files
    version                 Show version info

${GREEN}Examples:${NC}
    mayarictl up               # Start everything
    mayarictl up --no-flutter  # TTS server only
    mayarictl up --dev         # Start with Flutter in dev mode
    mayarictl status           # Check what's running
    mayarictl tts test         # Test TTS synthesis
    mayarictl logs tts         # Tail TTS logs

EOF
}

# ============== Main ==============

case "${1:-}" in
    up) shift; cmd_up "$@" ;;
    down) cmd_down ;;
    restart) shift; cmd_restart "$@" ;;
    status) cmd_status ;;
    tts)
        case "${2:-}" in
            start) start_tts ;;
            stop) stop_tts ;;
            test) test_tts ;;
            status)
                echo -e "${BLUE}TTS Server Status:${NC}"
                print_status "TTS Server" $TTS_PORT
                ;;
            *) echo "Usage: mayarictl tts {start|stop|test|status}" ;;
        esac
        ;;
    flutter)
        case "${2:-}" in
            start)
                mode="release"
                [ "${3:-}" = "--dev" ] && mode="dev"
                start_flutter "$mode"
                ;;
            stop) stop_flutter ;;
            build) build_flutter ;;
            *) echo "Usage: mayarictl flutter {start|stop|build}" ;;
        esac
        ;;
    logs) shift; cmd_logs "${1:-tts}" ;;
    clean)
        echo -e "${BLUE}Cleaning temporary files...${NC}"
        rm -f "$LOG_DIR"/*.log 2>/dev/null || true
        rm -f "$PID_DIR"/*.pid 2>/dev/null || true
        echo -e "${GREEN}Cleaned.${NC}"
        ;;
    version)
        echo -e "${BLUE}Mayari - PDF Quote Extraction with TTS${NC}"
        echo "Version: 1.0.0"
        echo "Root: $ROOT_DIR"
        echo ""
        echo "Components:"
        command -v python3 >/dev/null && echo "  Python: $(python3 --version 2>&1 | cut -d' ' -f2)"
        command -v flutter >/dev/null && echo "  Flutter: $(flutter --version 2>&1 | head -1 | cut -d' ' -f2)"
        echo ""
        echo "Backend: $BACKEND_DIR"
        if [ -d "$VENV_DIR" ]; then
            echo -e "  venv: ${GREEN}Installed${NC}"
        else
            echo -e "  venv: ${RED}Not installed${NC} (run: mayarictl tts start)"
        fi
        ;;
    help|-h|--help) usage ;;
    *) usage ;;
esac
